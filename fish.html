<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<style type="text/css">
			*{margin:0;padding:0;}
			body{background:#000;text-align:center;}
			#c1{background:url(img/game_bg_2_hd.jpg) no-repeat;margin:20px auto;}
			#crazy{width:100%;height:40px;
			position:relative;margin-top:20px;}
			#crazy p{
				position:absolute;left:50%;margin-left:-50px;
				background:red;width:100px;height:40px;text-align:center;
				line-height:40px;cursor:pointer;font-size:20px;
			}
		</style>
		<script src="js/initial.js"></script>
		<script src="js/sprite.js"></script>
		<script src="js/fish.js"></script>
		<script src="js/cannon.js"></script>
		<script src="js/bullet.js"></script>
		<script type="text/javascript">
			window.onload=function () {
				var oC=document.getElementById("c1");
				var gd=oC.getContext("2d");
				
				loadImages({
					fish1:"img/fish1.png",
					fish2:"img/fish2.png",
					fish3:"img/fish3.png",
					fish4:"img/fish4.png",
					fish5:"img/fish5.png",
					cannon1:"img/cannon1.png",
					cannon2:"img/cannon2.png",
					cannon3:"img/cannon3.png",
					cannon4:"img/cannon4.png",
					cannon5:"img/cannon5.png",
					cannon6:"img/cannon6.png",
					cannon7:"img/cannon7.png",
					bottom:"img/bottom.png",
					bullet:"img/bullet.png",
				},function(json){
					//创建精灵
					//鱼
					var aFish = [];
					var timer=setInterval(function(){
						var f = new Fish(json,rnd(1,6));
						f.x = -100;
						f.y = rnd(10,oC.height);
						 
						aFish.push(f);
					},1000);
					
					//炮台
					var bottom=new Sprite(json.bottom);
					bottom.w=765;
					bottom.h=70;
					
					bottom.x=oC.width/2;
					bottom.y=oC.height-bottom.h/2;
					
					//炮
					var cannon=new Cannon(json,1);
					cannon.x=440;
					cannon.y=570;
					
				/*	//炮弹
					var bullet=new Bullet(json.bullet,cannon.type);
					bullet.x=cannon.x;
					bullet.y=cannon.y;*/
					
					oC.onmousemove=function (ev) {
						var x1=cannon.x+oC.offsetLeft;
						var y1=cannon.y+oC.offsetTop;
						
						var x2=ev.pageX;
						var y2=ev.pageY;
						
						var x=x2-x1;
						var y=y1-y2;
						
						var rotate = 90 - a2d(Math.atan2(y,x));
						cannon.rotate=rotate;
						
						
					};
					//开炮
					var aBullet=[];
					oC.onclick=function (ev) {
							
							var bullet=new Bullet(json.bullet,cannon.type);
							bullet.x=cannon.x;
							bullet.y=cannon.y;
							
							bullet.speed=5;
							bullet.rotate=cannon.rotate;
							aBullet.push(bullet);
						return false;
						ev.preventDefault();
					};
					
					
					//狂暴模式
					var oCrazy=document.getElementById("crazy");
					
					oCrazy.onclick=function (ev) {
						clearInterval(timer);
						var timer=setInterval(function(){
							var f = new Fish(json,rnd(1,6));
							f.x = -100;
							f.y = rnd(0,oC.height);
							 
							aFish.push(f);
						},60); 
						oC.onclick=function () {
							for(var i = -8; i < 8; i++){
								var bullet=new Bullet(json.bullet,cannon.type);
								bullet.x=cannon.x;
								bullet.y=cannon.y;
								
								bullet.speed=5;
								bullet.rotate=cannon.rotate+ 5*i;
								aBullet.push(bullet);
							}
							oC.cancelBubble&&oC.cancelBubble();
							return false;
						};
						
					};
					
					
					
					
					

					setInterval(function () {
						gd.clearRect(0,0,oC.width,oC.height);
						//鱼
						for(var i=0;i<aFish.length;i++){
							aFish[i].draw(gd);
							aFish[i].move();
						}
						
						//炮台
						bottom.draw(gd);
						
						//炮
						cannon.draw(gd);

						//炮弹
						for(var i=0;i<aBullet.length;i++){
							aBullet[i].draw(gd);
							aBullet[i].move();
						}
						
						//碰撞检测
						for(var i=0;i<aBullet.length;i++){
							for(var j=0;j<aFish.length;j++){
								if(aFish[j].collTest(aBullet[i])){
									aBullet.splice(i--,1);
									aFish.splice(j--,1);
								}
							}
							
						}
					},30)
				});
			};
		</script>
	</head>
	<body>
		<canvas id="c1" width="800" height="600"></canvas>
		<div id="crazy">
			<p>狂暴模式</p>
		</div>
	</body>
</html>

