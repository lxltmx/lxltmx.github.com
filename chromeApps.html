<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<style type="text/css">
			*{margin:0;padding:0;}
			ul{width:900px;margin:50px auto;overflow:hidden;}
			li{list-style:none;float:left;margin:30px;border:10px solid #000;background:#fff;}
		</style>
		<script src="js/move.js" type="text/javascript"></script>
		<script type="text/javascript">
			window.onload=function () {
				//布局转换，添加拖拽，碰撞检测（collTest）
				var oUl=document.getElementById("ul1");
				var aLi=oUl.children;
				var zIndex=2;
				//布局转换
				var aPos=[];
				for(var i=0;i<aLi.length;i++){
					aPos.push({left:aLi[i].offsetLeft,top:aLi[i].offsetTop});
					aLi[i].style.left=aPos[i].left+'px';
					aLi[i].style.top=aPos[i].top+'px';
				}
				for(var i=0;i<aLi.length;i++){
					aLi[i].style.position='absolute';
					aLi[i].style.margin=0;
					aLi[i].index=i;
				}
				for(var i=0;i<aLi.length;i++){
					drag(aLi[i]);
				}
				//拖拽函数
				function drag (obj) {
					obj.onmousedown=function (ev) {
						obj.style.zIndex=zIndex++;
						clearInterval(obj.timer);//清除动画，防止运动过程中按下抖动
						var oEvt=ev||event;
						var disX=oEvt.clientX-obj.offsetLeft;
						var disY=oEvt.clientY-obj.offsetTop;
						document.onmousemove=function (ev) {
							var oEvt=ev||event;
							obj.style.left=oEvt.clientX-disX+'px';
							obj.style.top=oEvt.clientY-disY+'px';
							
							var nearObj=findNearest(obj);
							if(nearObj&&nearObj!=obj){
								/*//交换位置
								move(nearObj,aPos[obj.index]);	
								//交换下标		
								var tmp=obj.index;
								obj.index=nearObj.index;
								nearObj.index=tmp;*/
								var n=obj.index;//拖拽着的obj索引
								var m=nearObj.index;//被撞的最近obj的索引
								for(var i=0;i<aLi.length;i++){
									if(aLi[i].index>n&&aLi[i].index<=m){
										aLi[i].index--;
										move(aLi[i],aPos[aLi[i].index]);
									}else if(aLi[i].index<n&&aLi[i].index>=m){
										aLi[i].index++;
										move(aLi[i],aPos[aLi[i].index]);
									}
								}
								obj.index=m;
							}
						}
						document.onmouseup=function () {
							document.onmousemove=document.onmouseup=null;
							
							move(obj,aPos[obj.index]);//没撞到，回自己原来位置
							
							obj.releaseCapture&&obj.releaseCapture();
						}
						obj.setCapture&&obj.setCapture();
						return false;
					}
				}
				//碰撞检测函数
				function collTest (obj1,obj2) {
					var l1=obj1.offsetLeft;
					var t1=obj1.offsetTop;
					var r1=obj1.offsetLeft+obj1.offsetWidth;
					var b1=obj1.offsetTop+obj1.offsetHeight;
					var l2=aPos[obj2.index].left;
					var t2=aPos[obj2.index].top;
					var r2=aPos[obj2.index].left+obj2.offsetWidth;
					var b2=aPos[obj2.index].top+obj2.offsetHeight;
					if(r1<l2||t1>b2||l1>r2||b1<t2){
						return false;
					}else{
						return true;
					}
				}
				
				//找最近函数
				function findNearest (obj) {
					var minDis=999999999999;
					var minDisIndex=-1;
					for(var i=0;i<aLi.length;i++){
						if(collTest(obj,aLi[i])){//撞到了
							//console.log('peng')
							//找最近
							var dis=getDis(obj,aLi[i]);
							if(dis<minDis){
								minDis=dis;
								minDisIndex=i;
							}
						}
					}
					if(minDisIndex==-1){
						return null;
					}else{//console.log(minDis)
						return aLi[minDisIndex];
						
					}
				}
				//获取距离函数
				function getDis (obj1,obj2) {
					var a=aPos[obj2.index].top-obj1.offsetTop;
					var b=aPos[obj2.index].left-obj1.offsetLeft;
					return	Math.sqrt(a*a+b*b);
				}
			}
		</script>
	</head>
	<body>
		<ul id="ul1" class="clearFix">
			<li><img src='img2/1.png' /></li>
			<li><img src='img2/2.png' /></li>
			<li><img src='img2/3.png' /></li>
			<li><img src='img2/4.png' /></li>
			<li><img src='img2/5.png' /></li>
			<li><img src='img2/6.png' /></li>
			<li><img src='img2/7.png' /></li>
			<li><img src='img2/8.png' /></li>
			<li><img src='img2/9.png' /></li>
		</ul>
		
	</body>
</html>
